<!-- Fonts + Chart.js -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --bg-primary: #0a0e17;
        --bg-secondary: #111827;
        --bg-card: #1a2234;
        --bg-elevated: #222d42;
        --accent-primary: #00d4aa;
        --accent-secondary: #6366f1;
        --accent-tertiary: #f59e0b;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --text-muted: #64748b;
        --border-color: #2a3548;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --glass: rgba(26, 34, 52, 0.85);
        --shadow-glow: 0 0 40px rgba(0, 212, 170, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { font-size: 15px; }

    body {
        font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
        overflow-x: hidden;
    }

    body::before {
        content: '';
        position: fixed;
        top: -50%; left: -50%;
        width: 200%; height: 200%;
        background: radial-gradient(ellipse at 20% 20%, rgba(0, 212, 170, 0.08) 0%, transparent 50%),
                    radial-gradient(ellipse at 80% 80%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                    radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.03) 0%, transparent 70%);
        pointer-events: none;
        z-index: -1;
        animation: backgroundPulse 20s ease-in-out infinite alternate;
    }

    @keyframes backgroundPulse {
        0% { transform: rotate(0deg) scale(1); }
        100% { transform: rotate(5deg) scale(1.1); }
    }

    .app-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 24px;
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 24px;
        min-height: 100vh;
    }

    @media (max-width: 1200px) {
        .app-container { grid-template-columns: 1fr; }
    }

    .header {
        grid-column: 1 / -1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 28px;
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        animation: slideDown 0.6s ease-out;
        flex-wrap: wrap;
        gap: 16px;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .logo-icon {
        width: 48px; height: 48px;
        background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: var(--shadow-glow);
    }

    .logo h1 {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-primary) 0%, var(--text-primary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-stats {
        display: flex;
        gap: 24px;
        align-items: center;
        flex-wrap: wrap;
    }

    .currency-switcher {
        display: flex;
        background: var(--bg-elevated);
        border-radius: 12px;
        padding: 4px;
        border: 1px solid var(--border-color);
    }

    .currency-btn {
        padding: 8px 16px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .currency-btn.active {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        color: white;
    }

    .currency-btn:hover:not(.active) {
        color: var(--text-primary);
    }

    .total-value-display { text-align: right; }

    .total-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 4px;
    }

    .total-amount {
        font-size: 2.2rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-primary);
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: rgba(16, 185, 129, 0.15);
        border-radius: 30px;
        font-size: 0.85rem;
        color: var(--success);
    }

    .status-dot {
        width: 8px; height: 8px;
        background: var(--success);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }

    .main-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .card {
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        overflow: hidden;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .card-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .card-title {
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-title-icon {
        width: 32px; height: 32px;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .card-body { padding: 24px; }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        animation: slideUp 0.5s ease-out 0.2s both;
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 900px) {
        .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .metric-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .metric-card:hover {
        border-color: var(--accent-primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-glow);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 3px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        opacity: 0;
        transition: opacity 0.3s;
    }

    .metric-card:hover::before { opacity: 1; }

    .metric-icon {
        width: 40px; height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        margin-bottom: 14px;
    }

    .metric-icon.stocks { background: rgba(99, 102, 241, 0.15); }
    .metric-icon.crypto { background: rgba(245, 158, 11, 0.15); }
    .metric-icon.holdings { background: rgba(0, 212, 170, 0.15); }
    .metric-icon.updated { background: rgba(148, 163, 184, 0.15); }

    .metric-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
    }

    .holdings-container {
        max-height: 500px;
        overflow-y: auto;
    }

    .holdings-container::-webkit-scrollbar { width: 6px; }
    .holdings-container::-webkit-scrollbar-track { background: var(--bg-card); border-radius: 3px; }
    .holdings-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
    .holdings-container::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

    .holdings-table { width: 100%; border-collapse: collapse; }

    .holdings-table th {
        padding: 14px 16px;
        text-align: left;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        background: var(--bg-secondary);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .holdings-table td {
        padding: 16px;
        font-size: 0.9rem;
        border-bottom: 1px solid var(--border-color);
    }

    .holdings-table tr { transition: background 0.2s; }
    .holdings-table tr:hover td { background: rgba(0, 212, 170, 0.03); }

    .asset-cell {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .asset-icon {
        width: 36px; height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        color: white;
    }

    .asset-icon.stock { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
    .asset-icon.crypto { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
    .asset-icon.etf { background: linear-gradient(135deg, #10b981, #34d399); }
    .asset-icon.reit { background: linear-gradient(135deg, #ec4899, #f472b6); }

    .asset-info { display: flex; flex-direction: column; }

    .asset-ticker {
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
    }

    .asset-name {
        font-size: 0.75rem;
        color: var(--text-secondary);
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .type-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .type-badge.stock { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
    .type-badge.crypto { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
    .type-badge.etf { background: rgba(16, 185, 129, 0.15); color: #34d399; }
    .type-badge.reit { background: rgba(236, 72, 153, 0.15); color: #f472b6; }

    .value-cell {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
        text-align: right;
    }

    .pnl-positive { color: var(--success); }
    .pnl-negative { color: var(--danger); }

    .weight-bar-container {
        width: 80px; height: 6px;
        background: var(--bg-secondary);
        border-radius: 3px;
        overflow: hidden;
    }

    .weight-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    @media (max-width: 900px) {
        .charts-grid { grid-template-columns: 1fr; }
    }

    .chart-container { height: 250px; position: relative; }

    .advisor-panel {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        position: sticky;
        top: 24px;
    }

    @media (max-width: 1200px) {
        .advisor-panel { height: 600px; position: static; }
    }

    .advisor-card { flex: 1; display: flex; flex-direction: column; }

    .advisor-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .advisor-avatar {
        width: 48px; height: 48px;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: var(--shadow-glow);
    }

    .advisor-info h3 { font-size: 1rem; font-weight: 600; }
    .advisor-info p { font-size: 0.75rem; color: var(--text-secondary); }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: var(--bg-card); }
    .chat-messages::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

    .message {
        max-width: 90%;
        padding: 14px 18px;
        border-radius: 16px;
        font-size: 0.9rem;
        line-height: 1.6;
        animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }

    .message.assistant {
        background: var(--bg-elevated);
        border: 1px solid var(--border-color);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }

    .message.system {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: var(--accent-tertiary);
        align-self: center;
        font-size: 0.8rem;
        text-align: center;
    }

    .chat-input-container {
        padding: 16px 20px;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 12px;
    }

    .chat-input {
        flex: 1;
        padding: 14px 18px;
        background: var(--bg-elevated);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        color: var(--text-primary);
        font-family: inherit;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.2s;
    }

    .chat-input:focus { border-color: var(--accent-primary); }
    .chat-input::placeholder { color: var(--text-muted); }

    .send-btn {
        width: 48px; height: 48px;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        border: none;
        border-radius: 12px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .send-btn:hover { transform: scale(1.05); box-shadow: var(--shadow-glow); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .send-btn svg { width: 20px; height: 20px; }

    .quick-actions {
        padding: 12px 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        border-top: 1px solid var(--border-color);
    }

    .quick-action-btn {
        padding: 8px 14px;
        background: var(--bg-elevated);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        color: var(--text-secondary);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-action-btn:hover {
        background: var(--accent-primary);
        color: var(--bg-primary);
        border-color: var(--accent-primary);
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-family: inherit;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        color: white;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-glow); }

    .btn-secondary {
        background: var(--bg-elevated);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .btn-secondary:hover { border-color: var(--accent-primary); }

    .typing-indicator { display: flex; gap: 4px; padding: 8px 0; }

    .typing-dot {
        width: 8px; height: 8px;
        background: var(--text-muted);
        border-radius: 50%;
        animation: typingBounce 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
    }

    .price-source {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 6px;
    }

    .price-source.live { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .price-source.cached { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

    .filter-tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-tab {
        padding: 6px 14px;
        background: var(--bg-elevated);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-tab:hover, .filter-tab.active {
        background: var(--accent-primary);
        color: var(--bg-primary);
        border-color: var(--accent-primary);
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 14, 23, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.5s;
    }

    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 3px solid var(--border-color);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        margin-top: 20px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .error-banner {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 16px;
        color: #fca5a5;
        font-size: 0.85rem;
        display: none;
    }

    .error-banner.show { display: block; }

    .config-status {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 16px;
    }

    .config-status h3 {
        font-size: 0.9rem;
        margin-bottom: 12px;
        color: var(--text-primary);
    }

    .config-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 0.85rem;
    }

    .config-item:last-child { margin-bottom: 0; }

    .config-check { font-size: 1rem; }
    .config-check.ok { color: var(--success); }
    .config-check.fail { color: var(--danger); }
</style>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Connecting to APIs...</div>
</div>

<div class="app-container">
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üìä</div>
            <h1>Portfolio Command Center</h1>
        </div>
        <div class="header-stats">
            <div class="currency-switcher">
                <button class="currency-btn active" id="btnGBP" onclick="setCurrency('GBP')">¬£ GBP</button>
                <button class="currency-btn" id="btnUSD" onclick="setCurrency('USD')">$ USD</button>
            </div>
            <div class="total-value-display">
                <div class="total-label">Total Portfolio Value</div>
                <div class="total-amount" id="totalValue">¬£0</div>
            </div>
            <div class="status-indicator" id="statusIndicator">
                <div class="status-dot"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Error Banner -->
        <div class="error-banner" id="errorBanner"></div>

        <!-- Config Status -->
        <div class="config-status" id="configStatus" style="display: none;">
            <h3>üîß API Configuration Status</h3>
            <div class="config-item">
                <span class="config-check" id="t212Check">‚è≥</span>
                <span>Trading 212 API</span>
            </div>
            <div class="config-item">
                <span class="config-check" id="cgCheck">‚è≥</span>
                <span>CoinGecko API</span>
            </div>
            <div class="config-item">
                <span class="config-check" id="aiCheck">‚è≥</span>
                <span>AI Advisor (Anthropic)</span>
            </div>
        </div>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon stocks">üìà</div>
                <div class="metric-label">Stocks & ETFs</div>
                <div class="metric-value" id="stocksValue">¬£0</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon crypto">ü™ô</div>
                <div class="metric-label">Cryptocurrency</div>
                <div class="metric-value" id="cryptoValue">¬£0</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon holdings">üéØ</div>
                <div class="metric-label">Total Holdings</div>
                <div class="metric-value" id="holdingsCount">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon updated">üïê</div>
                <div class="metric-label">Last Updated</div>
                <div class="metric-value" id="lastUpdated" style="font-size: 1rem;">--:--</div>
            </div>
        </div>

        <!-- Holdings Table -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-title-icon">üìã</div>
                    Holdings
                </div>
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterHoldings('all')">All</button>
                        <button class="filter-tab" onclick="filterHoldings('Crypto')">Crypto</button>
                        <button class="filter-tab" onclick="filterHoldings('Stock')">Stocks</button>
                        <button class="filter-tab" onclick="filterHoldings('ETF')">ETFs</button>
                        <button class="filter-tab" onclick="filterHoldings('REIT')">REITs</button>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshAll()" style="padding: 8px 16px;">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            <div class="holdings-container">
                <table class="holdings-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Asset</th>
                            <th style="text-align: left;">Type</th>
                            <th style="text-align: right;">Quantity</th>
                            <th style="text-align: right;">Price</th>
                            <th style="text-align: right;">Value</th>
                            <th style="text-align: right;">P&L</th>
                            <th style="text-align: left;">Weight</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon">ü•ß</div>
                        Asset Allocation
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon">üèÜ</div>
                        Top 10 Holdings
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topHoldingsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- AI Advisor Panel -->
    <aside class="advisor-panel">
        <div class="card advisor-card">
            <div class="advisor-header">
                <div class="advisor-avatar">ü§ñ</div>
                <div class="advisor-info">
                    <h3>AI Financial Advisor</h3>
                    <p>Powered by Claude ‚Ä¢ Your portfolio assistant</p>
                </div>
            </div>

            <div class="quick-actions">
                <button class="quick-action-btn" onclick="askAdvisor('Give me a quick overview of my portfolio health')">üìä Analysis</button>
                <button class="quick-action-btn" onclick="askAdvisor('What are the main risks I should be aware of?')">‚ö†Ô∏è Risks</button>
                <button class="quick-action-btn" onclick="askAdvisor('How diversified is my portfolio?')">üéØ Diversify</button>
                <button class="quick-action-btn" onclick="askAdvisor('Which holdings are performing best?')">üèÜ Top Picks</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    Welcome! I'm your AI financial advisor. Ask me anything about your portfolio.
                </div>
            </div>

            <div class="chat-input-container">
                <input
                    type="text"
                    class="chat-input"
                    id="chatInput"
                    placeholder="Ask about your portfolio..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </aside>
</div>

<script>
    // =============================================================================
    // STATE
    // =============================================================================

    let state = {
        holdings: [],
        cryptoHoldings: [],
        totalValue: 0,
        stocksValue: 0,
        cryptoValue: 0,
        lastUpdate: null,
        currency: 'GBP',
        exchangeRate: { gbpToUsd: 1.27, usdToGbp: 0.79 },
        charts: { allocation: null, topHoldings: null },
        chatHistory: [],
        currentFilter: 'all',
        apiConfig: { t212: false, coingecko: false, anthropic: false }
    };

    // =============================================================================
    // CRYPTO MAPPING
    // =============================================================================

    const CRYPTO_MAP = {
        'BTC': 'bitcoin', 'WBTC': 'wrapped-bitcoin', 'BTCB': 'bitcoin',
        'ETH': 'ethereum', 'WETH': 'weth', 'STETH': 'staked-ether',
        'SOL': 'solana', 'BNB': 'binancecoin', 'XRP': 'ripple',
        'ADA': 'cardano', 'DOGE': 'dogecoin', 'DOGE-BEP': 'dogecoin',
        'DOT': 'polkadot', 'DOT-BEP': 'polkadot', 'LINK': 'chainlink',
        'AVAX': 'avalanche-2', 'SHIB': 'shiba-inu', 'LTC': 'litecoin',
        'TRX': 'tron', 'BCH': 'bitcoin-cash', 'FTM': 'fantom',
        'ARB': 'arbitrum', 'INJ': 'injective-protocol', 'SUI': 'sui',
        'USDT': 'tether', 'ZUSDT': 'tether', 'USDT-Linea': 'tether', 'BSC-USD': 'tether',
        'USDC': 'usd-coin', 'USDC.E': 'usd-coin', 'BUSD': 'binance-usd',
        'PEPE': 'pepe', 'BONK': 'bonk', 'FLOKI': 'floki',
        'WIF': 'dogwifhat', 'PONKE': 'ponke', '$MYRO': 'myro',
        'POL': 'matic-network', 'TIA': 'celestia', 'METIS': 'metis-token',
        'FET': 'artificial-superintelligence-alliance',
        'RENDER': 'render-token', 'JUP': 'jupiter-exchange-solana',
        'ORCA': 'orca', 'PAXG': 'pax-gold', 'OMNOM': 'doge-eat-doge',
    };

    // Crypto holdings - EDIT THIS SECTION WITH YOUR CRYPTO HOLDINGS
    const CRYPTO_HOLDINGS = [
        { ticker: 'WBTC', name: 'Wrapped Bitcoin', units: 2.09433415, costBasisUsd: 67550.45 },
        { ticker: 'ZUSDT', name: 'Bridged Tether Zilliqa', units: 135106.8131, costBasisUsd: 0.9472 },
        { ticker: 'USDT', name: 'Tether USD', units: 10000, costBasisUsd: 1.00 },
        { ticker: 'BSC-USD', name: 'Binance-Peg BSC-USD', units: 44685.23, costBasisUsd: 1.00 },
        { ticker: 'ETH', name: 'Ethereum', units: 7.1598, costBasisUsd: 2850 },
        { ticker: 'SOL', name: 'Solana', units: 48.08, costBasisUsd: 145 },
        { ticker: 'BNB', name: 'BNB', units: 12.8866, costBasisUsd: 580 },
        { ticker: 'TIA', name: 'Celestia', units: 372.83, costBasisUsd: 8.25 },
        { ticker: 'SUI', name: 'Sui', units: 1250.12, costBasisUsd: 1.85 },
        { ticker: 'METIS', name: 'Metis Token', units: 42.47, costBasisUsd: 68 },
        { ticker: 'INJ', name: 'Injective', units: 70.5, costBasisUsd: 28 },
        { ticker: 'PEPE', name: 'Pepe', units: 150000000, costBasisUsd: 0.0000085 },
        { ticker: 'BONK', name: 'Bonk', units: 15000000, costBasisUsd: 0.000018 },
        { ticker: 'WIF', name: 'dogwifhat', units: 450, costBasisUsd: 2.15 },
        { ticker: 'FLOKI', name: 'FLOKI', units: 2500000, costBasisUsd: 0.00015 },
        { ticker: 'FET', name: 'Artificial Superintelligence Alliance', units: 520, costBasisUsd: 1.85 },
        { ticker: 'RENDER', name: 'Render Token', units: 85, costBasisUsd: 7.50 },
        { ticker: 'JUP', name: 'Jupiter', units: 1200, costBasisUsd: 0.95 },
        { ticker: 'OMNOM', name: 'Doge Eat Doge', units: 2590000000, costBasisUsd: 0.0000536 },
        { ticker: 'PONKE', name: 'Ponke', units: 2500, costBasisUsd: 0.42 },
    ];

    // =============================================================================
    // CURRENCY UTILITIES
    // =============================================================================

    function setCurrency(currency) {
        state.currency = currency;
        document.getElementById('btnGBP').classList.toggle('active', currency === 'GBP');
        document.getElementById('btnUSD').classList.toggle('active', currency === 'USD');
        updateUI();
    }

    function convertToDisplayCurrency(valueGbp) {
        if (state.currency === 'USD') {
            return valueGbp * state.exchangeRate.gbpToUsd;
        }
        return valueGbp;
    }

    function formatCurrency(value) {
        if (!value && value !== 0) return state.currency === 'GBP' ? '¬£0' : '$0';
        const symbol = state.currency === 'GBP' ? '¬£' : '$';
        const displayValue = convertToDisplayCurrency(value);
        return symbol + displayValue.toLocaleString('en-GB', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function formatPrice(price) {
        if (!price) return state.currency === 'GBP' ? '¬£0.00' : '$0.00';
        const symbol = state.currency === 'GBP' ? '¬£' : '$';
        let displayPrice = convertToDisplayCurrency(price);

        if (displayPrice < 0.0001) return symbol + displayPrice.toExponential(2);
        if (displayPrice < 0.01) return symbol + displayPrice.toFixed(6);
        if (displayPrice < 1) return symbol + displayPrice.toFixed(4);
        return symbol + displayPrice.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatNumber(num) {
        if (!num) return '0';
        if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
        if (num >= 1000) return num.toLocaleString('en-GB', { maximumFractionDigits: 2 });
        if (num < 0.0001) return num.toExponential(2);
        return num.toFixed(4);
    }

    function formatPnl(pnl, pnlPercent) {
        if (pnl === null || pnl === undefined) return '-';
        const symbol = state.currency === 'GBP' ? '¬£' : '$';
        const displayPnl = convertToDisplayCurrency(pnl);
        const sign = displayPnl >= 0 ? '+' : '';
        return `${sign}${symbol}${Math.abs(displayPnl).toLocaleString('en-GB', { maximumFractionDigits: 0 })} (${sign}${pnlPercent?.toFixed(1) || 0}%)`;
    }

    function truncate(str, len) {
        if (!str) return '';
        return str.length > len ? str.substring(0, len) + '...' : str;
    }

    // =============================================================================
    // API CALLS (Using server proxy)
    // =============================================================================

    async function checkApiConfig() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();
            state.apiConfig = {
                t212: config.t212Configured,
                coingecko: config.coingeckoConfigured,
                anthropic: config.anthropicConfigured
            };

            document.getElementById('t212Check').textContent = config.t212Configured ? '‚úÖ' : '‚ùå';
            document.getElementById('t212Check').className = 'config-check ' + (config.t212Configured ? 'ok' : 'fail');

            document.getElementById('cgCheck').textContent = config.coingeckoConfigured ? '‚úÖ' : '‚ö†Ô∏è';
            document.getElementById('cgCheck').className = 'config-check ' + (config.coingeckoConfigured ? 'ok' : 'fail');

            document.getElementById('aiCheck').textContent = config.anthropicConfigured ? '‚úÖ' : '‚ùå';
            document.getElementById('aiCheck').className = 'config-check ' + (config.anthropicConfigured ? 'ok' : 'fail');

            return config;
        } catch (error) {
            console.error('Config check failed:', error);
            return { t212Configured: false, coingeckoConfigured: false, anthropicConfigured: false };
        }
    }

    async function fetchExchangeRate() {
        try {
            const response = await fetch('/api/exchange-rate');
            const data = await response.json();
            state.exchangeRate = data;
        } catch (e) {
            console.log('Using default exchange rate');
        }
    }

    async function fetchT212Portfolio() {
        updateLoadingText('Fetching Trading 212 portfolio...');

        try {
            const response = await fetch('/api/t212/portfolio');
            if (!response.ok) throw new Error('T212 API error');

            const data = await response.json();
            console.log('‚úÖ T212 Portfolio fetched:', data.length, 'positions');
            return processT212Data(data);
        } catch (error) {
            console.error('T212 fetch error:', error);
            showError('Could not fetch Trading 212 data. Check your API key configuration.');
            return [];
        }
    }

    function processT212Data(data) {
        return data.map(position => {
            let priceGbp = position.currentPrice || 0;
            let avgPriceGbp = position.averagePrice || 0;

            const ticker = position.ticker || '';
            const isLikelyGbx = priceGbp > 100 && !ticker.includes('.');

            if (isLikelyGbx) {
                priceGbp = priceGbp / 100;
                avgPriceGbp = avgPriceGbp / 100;
            }

            const units = position.quantity || 0;
            const currentValue = units * priceGbp;
            const costValue = units * avgPriceGbp;
            const pnl = currentValue - costValue;
            const pnlPercent = costValue > 0 ? ((currentValue - costValue) / costValue) * 100 : 0;

            let type = 'Stock';
            if (/^(VUSA|VWRL|VWRP|VUKE|VUKG|VHYL|VFEG|SPY4|LDEG|XMJP|EIMI|HEAL|IHCU|SMGB|RENG|SGLN|ISPY|DLTM|GGRB|IUKD|UGRW|WNDG|QDVE|NRGT|IITU|TRET|IUSP|FXC|SEMB)/.test(ticker)) {
                type = 'ETF';
            } else if (/^(PCTN|SUPR|SGRO)/.test(ticker)) {
                type = 'REIT';
            }

            return {
                ticker: ticker.replace('_EQ', ''),
                name: position.name || ticker,
                type,
                units,
                currentPrice: priceGbp,
                avgPrice: avgPriceGbp,
                currentValue,
                costValue,
                pnl,
                pnlPercent,
                priceSource: 'live',
                isCrypto: false
            };
        }).filter(h => h.units > 0);
    }

    // ‚úÖ UPDATED: only request prices for tickers you actually hold (via server proxy)
    async function fetchCryptoPrices() {
        updateLoadingText('Fetching crypto prices...');

        const heldTickers = [...new Set(CRYPTO_HOLDINGS.map(h => h.ticker))];
        const uniqueCoinIds = [...new Set(
            heldTickers.map(t => CRYPTO_MAP[t]).filter(Boolean)
        )];

        if (!uniqueCoinIds.length) return {};

        try {
            const response = await fetch(`/api/crypto/prices?ids=${uniqueCoinIds.join(',')}`);
            if (!response.ok) throw new Error('CoinGecko API error');

            const data = await response.json();
            const cryptoPrices = {};

            for (const ticker of heldTickers) {
                const coinId = CRYPTO_MAP[ticker];
                if (coinId && data[coinId]) {
                    cryptoPrices[ticker] = {
                        gbp: data[coinId].gbp || 0,
                        usd: data[coinId].usd || 0,
                        change24h: data[coinId].gbp_24h_change || 0
                    };
                }
            }

            console.log('‚úÖ Fetched crypto prices:', Object.keys(cryptoPrices).length);
            return cryptoPrices;
        } catch (error) {
            console.error('Crypto price fetch error:', error);
            return {};
        }
    }

    function processCryptoHoldings(cryptoPrices) {
        return CRYPTO_HOLDINGS.map(holding => {
            const price = cryptoPrices[holding.ticker];
            const currentPriceGbp = price?.gbp || (holding.costBasisUsd * state.exchangeRate.usdToGbp);
            const costPriceGbp = holding.costBasisUsd * state.exchangeRate.usdToGbp;

            const currentValue = holding.units * currentPriceGbp;
            const costValue = holding.units * costPriceGbp;
            const pnl = currentValue - costValue;
            const pnlPercent = costValue > 0 ? ((currentValue - costValue) / costValue) * 100 : 0;

            return {
                ticker: holding.ticker,
                name: holding.name,
                type: 'Crypto',
                units: holding.units,
                currentPrice: currentPriceGbp,
                avgPrice: costPriceGbp,
                currentValue,
                costValue,
                pnl,
                pnlPercent,
                priceSource: price ? 'live' : 'cached',
                isCrypto: true
            };
        }).filter(h => h.units > 0 && h.currentValue > 0);
    }

    // =============================================================================
    // PORTFOLIO CALCULATIONS
    // =============================================================================

    function calculatePortfolio() {
        const allHoldings = [...state.holdings, ...state.cryptoHoldings];
        allHoldings.sort((a, b) => b.currentValue - a.currentValue);

        let totalValue = 0;
        let stocksValue = 0;
        let cryptoValue = 0;

        allHoldings.forEach(h => {
            totalValue += h.currentValue;
            if (h.isCrypto || h.type === 'Crypto') cryptoValue += h.currentValue;
            else stocksValue += h.currentValue;
        });

        allHoldings.forEach(h => {
            h.weight = totalValue > 0 ? (h.currentValue / totalValue) * 100 : 0;
        });

        state.holdings = allHoldings.filter(h => !h.isCrypto);
        state.cryptoHoldings = allHoldings.filter(h => h.isCrypto);
        state.totalValue = totalValue;
        state.stocksValue = stocksValue;
        state.cryptoValue = cryptoValue;
        state.lastUpdate = new Date();

        return allHoldings;
    }

    // =============================================================================
    // UI UPDATES
    // =============================================================================

    function updateUI() {
        const allHoldings = [...state.holdings, ...state.cryptoHoldings].sort((a, b) => b.currentValue - a.currentValue);

        const total = state.totalValue;
        allHoldings.forEach(h => {
            h.weight = total > 0 ? (h.currentValue / total) * 100 : 0;
        });

        document.getElementById('totalValue').textContent = formatCurrency(state.totalValue);
        document.getElementById('stocksValue').textContent = formatCurrency(state.stocksValue);
        document.getElementById('cryptoValue').textContent = formatCurrency(state.cryptoValue);
        document.getElementById('holdingsCount').textContent = allHoldings.length;
        document.getElementById('lastUpdated').textContent = state.lastUpdate
            ? state.lastUpdate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })
            : '--:--';

        updateHoldingsTable(allHoldings);
        updateCharts(allHoldings);
    }

    function updateHoldingsTable(allHoldings) {
        const tbody = document.getElementById('holdingsBody');
        let filtered = allHoldings;

        if (state.currentFilter !== 'all') {
            filtered = allHoldings.filter(h => h.type === state.currentFilter);
        }

        tbody.innerHTML = filtered.map(h => {
            const typeClass = h.type.toLowerCase();
            const iconInitial = h.ticker.substring(0, 2);
            const priceSourceClass = h.priceSource === 'live' ? 'live' : 'cached';
            const priceSourceLabel = h.priceSource === 'live' ? 'LIVE' : 'EST';
            const pnlClass = h.pnl >= 0 ? 'pnl-positive' : 'pnl-negative';

            return `
                <tr>
                    <td>
                        <div class="asset-cell">
                            <div class="asset-icon ${typeClass}">${iconInitial}</div>
                            <div class="asset-info">
                                <div class="asset-ticker">${h.ticker}</div>
                                <div class="asset-name">${truncate(h.name, 20)}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="type-badge ${typeClass}">${h.type}</span></td>
                    <td class="value-cell">${formatNumber(h.units)}</td>
                    <td class="value-cell">
                        ${formatPrice(h.currentPrice)}
                        <span class="price-source ${priceSourceClass}">${priceSourceLabel}</span>
                    </td>
                    <td class="value-cell" style="font-weight: 600;">${formatCurrency(h.currentValue)}</td>
                    <td class="value-cell ${pnlClass}">${formatPnl(h.pnl, h.pnlPercent)}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="weight-bar-container">
                                <div class="weight-bar" style="width: ${Math.min(h.weight * 2, 100)}%;"></div>
                            </div>
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">${h.weight.toFixed(1)}%</span>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filterHoldings(type) {
        state.currentFilter = type;
        document.querySelectorAll('.filter-tab').forEach(tab => {
            const tabType = tab.textContent.trim();
            const isActive = (type === 'all' && tabType === 'All') ||
                             (type === 'Crypto' && tabType === 'Crypto') ||
                             (type === 'Stock' && tabType === 'Stocks') ||
                             (type === 'ETF' && tabType === 'ETFs') ||
                             (type === 'REIT' && tabType === 'REITs');
            tab.classList.toggle('active', isActive);
        });
        updateUI();
    }

    function updateCharts(allHoldings) {
        updateAllocationChart(allHoldings);
        updateTopHoldingsChart(allHoldings);
    }

    function updateAllocationChart(allHoldings) {
        const ctx = document.getElementById('allocationChart').getContext('2d');

        const typeValues = {};
        allHoldings.forEach(h => {
            typeValues[h.type] = (typeValues[h.type] || 0) + h.currentValue;
        });

        const labels = Object.keys(typeValues);
        const data = Object.values(typeValues).map(v => convertToDisplayCurrency(v));
        const colors = ['#f59e0b', '#6366f1', '#10b981', '#ec4899', '#8b5cf6', '#ef4444'];

        if (state.charts.allocation) state.charts.allocation.destroy();

        state.charts.allocation = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#94a3b8',
                            font: { family: 'DM Sans', size: 12 },
                            padding: 16,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    function updateTopHoldingsChart(allHoldings) {
        const ctx = document.getElementById('topHoldingsChart').getContext('2d');

        const top10 = allHoldings.slice(0, 10);
        const labels = top10.map(h => h.ticker);
        const data = top10.map(h => convertToDisplayCurrency(h.currentValue));
        const symbol = state.currency === 'GBP' ? '¬£' : '$';

        if (state.charts.topHoldings) state.charts.topHoldings.destroy();

        state.charts.topHoldings = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: 'rgba(0, 212, 170, 0.6)',
                    borderColor: '#00d4aa',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: {
                            color: '#64748b',
                            font: { family: 'JetBrains Mono', size: 10 },
                            callback: v => symbol + (v / 1000).toFixed(0) + 'k'
                        },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    y: {
                        ticks: { color: '#94a3b8', font: { family: 'JetBrains Mono', size: 11 } },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // =============================================================================
    // STATUS & LOADING
    // =============================================================================

    function updateStatus(text, type) {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        statusText.textContent = text;

        if (type === 'success') {
            indicator.style.background = 'rgba(16, 185, 129, 0.15)';
            indicator.style.color = '#10b981';
        } else if (type === 'error') {
            indicator.style.background = 'rgba(239, 68, 68, 0.15)';
            indicator.style.color = '#ef4444';
        } else {
            indicator.style.background = 'rgba(245, 158, 11, 0.15)';
            indicator.style.color = '#f59e0b';
        }
    }

    function updateLoadingText(text) {
        document.getElementById('loadingText').textContent = text;
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showError(message) {
        const banner = document.getElementById('errorBanner');
        banner.textContent = message;
        banner.classList.add('show');
        setTimeout(() => banner.classList.remove('show'), 10000);
    }

    // =============================================================================
    // AI ADVISOR
    // =============================================================================

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        input.value = '';
        showTypingIndicator();

        try {
            const response = await callClaudeAPI(message);
            removeTypingIndicator();
            addMessage(response, 'assistant');
        } catch (error) {
            removeTypingIndicator();
            addMessage('AI Advisor not available. Make sure ANTHROPIC_API_KEY is configured in your environment variables.', 'system');
        }
    }

    function askAdvisor(question) {
        document.getElementById('chatInput').value = question;
        sendMessage();
    }

    function buildPortfolioContext() {
        const allHoldings = [...state.holdings, ...state.cryptoHoldings].sort((a, b) => b.currentValue - a.currentValue);
        const top15 = allHoldings.slice(0, 15);

        const typeBreakdown = {};
        allHoldings.forEach(h => {
            typeBreakdown[h.type] = (typeBreakdown[h.type] || 0) + h.currentValue;
        });

        const totalPnl = allHoldings.reduce((sum, h) => sum + (h.pnl || 0), 0);
        const totalCost = allHoldings.reduce((sum, h) => sum + (h.costValue || 0), 0);
        const totalPnlPercent = totalCost > 0 ? (totalPnl / totalCost) * 100 : 0;

        return `
Portfolio Summary (values in GBP):
- Total Value: ¬£${state.totalValue.toLocaleString()}
- Stocks/ETFs/REITs: ¬£${state.stocksValue.toLocaleString()} (${((state.stocksValue/state.totalValue)*100).toFixed(1)}%)
- Cryptocurrency: ¬£${state.cryptoValue.toLocaleString()} (${((state.cryptoValue/state.totalValue)*100).toFixed(1)}%)
- Total Holdings: ${allHoldings.length}
- Overall P&L: ¬£${totalPnl.toLocaleString()} (${totalPnlPercent.toFixed(1)}%)

Asset Type Breakdown:
${Object.entries(typeBreakdown).map(([type, value]) =>
    `- ${type}: ¬£${value.toLocaleString()} (${((value/state.totalValue)*100).toFixed(1)}%)`
).join('\n')}

Top 15 Holdings:
${top15.map((h, i) =>
    `${i+1}. ${h.ticker} (${h.type}): ¬£${h.currentValue.toLocaleString()} - ${h.weight.toFixed(1)}%, P&L: ${h.pnl >= 0 ? '+' : ''}¬£${h.pnl?.toLocaleString() || 0}`
).join('\n')}
        `.trim();
    }

    async function callClaudeAPI(userMessage) {
        const systemPrompt = `You are a friendly, conversational financial advisor helping someone understand their investment portfolio.

GUIDELINES:
- Write naturally, like talking to a friend who's good with money
- Avoid bullet points - use flowing prose
- Be specific with numbers but explain what they mean simply
- Keep responses to 2-3 short paragraphs unless asked for detail
- You're NOT a licensed financial advisor - mention this only if giving buy/sell advice

Current Portfolio Data:
${buildPortfolioContext()}`;

        state.chatHistory.push({ role: 'user', content: userMessage });

        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: state.chatHistory.slice(-10),
                system: systemPrompt
            })
        });

        if (!response.ok) throw new Error('API error');

        const data = await response.json();
        const assistantMessage = data.content[0].text;
        state.chatHistory.push({ role: 'assistant', content: assistantMessage });

        return assistantMessage;
    }

    function addMessage(content, type) {
        const container = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = content;
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }

    function showTypingIndicator() {
        const container = document.getElementById('chatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message assistant';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
        container.appendChild(typingDiv);
        container.scrollTop = container.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    // =============================================================================
    // REFRESH
    // =============================================================================

    async function refreshAll() {
        updateStatus('Refreshing...', 'pending');

        try {
            await fetchExchangeRate();

            const t212Holdings = await fetchT212Portfolio();
            state.holdings = t212Holdings;

            const cryptoPrices = await fetchCryptoPrices();
            state.cryptoHoldings = processCryptoHoldings(cryptoPrices);

            calculatePortfolio();
            updateUI();

            updateStatus('Live', 'success');
        } catch (error) {
            console.error('Refresh error:', error);
            updateStatus('Error', 'error');
        }
    }

    // =============================================================================
    // INIT
    // =============================================================================

    async function init() {
        console.log('üöÄ Portfolio Command Center initializing...');

        try {
            updateLoadingText('Checking API configuration...');
            await checkApiConfig();

            updateLoadingText('Fetching exchange rates...');
            await fetchExchangeRate();

            const t212Holdings = await fetchT212Portfolio();
            state.holdings = t212Holdings;

            const cryptoPrices = await fetchCryptoPrices();
            state.cryptoHoldings = processCryptoHoldings(cryptoPrices);

            updateLoadingText('Calculating portfolio...');
            calculatePortfolio();

            updateUI();
            hideLoading();

            if (state.holdings.length > 0 || state.cryptoHoldings.length > 0) {
                updateStatus('Live', 'success');
            } else {
                updateStatus('No Data', 'warning');
                document.getElementById('configStatus').style.display = 'block';
            }

            console.log('‚úÖ Initialization complete');
            console.log(`üìä Total Portfolio: ${formatCurrency(state.totalValue)}`);

            setInterval(refreshAll, 60000);

        } catch (error) {
            console.error('‚ùå Initialization error:', error);
            hideLoading();
            updateStatus('Error', 'error');
            document.getElementById('configStatus').style.display = 'block';
        }
    }

    window.addEventListener('load', init);
</script>
